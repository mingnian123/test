import torch
import torch.nn as nn
from torchvision.models.segmentation import deeplabv3_resnet50
from torchvision.models.segmentation.deeplabv3 import DeepLabV3_ResNet50_Weights


class Stage1Segmenter(nn.Module):
    def __init__(self, cfg):
        super().__init__()
        # 加载COCO预训练的DeepLabV3+
        self.model = deeplabv3_resnet50(weights=DeepLabV3_ResNet50_Weights.COCO_WITH_VOC_LABELS_V1)

        # 修改输入通道为3
        original_conv = self.model.backbone.conv1
        self.model.backbone.conv1 = nn.Conv2d(
            3,  # 仅使用RGB
            original_conv.out_channels,
            kernel_size=original_conv.kernel_size,
            stride=original_conv.stride,
            padding=original_conv.padding,
            bias=original_conv.bias is not None
        )

        # 修改分类头为二分类
        self.model.classifier[4] = nn.Conv2d(256, cfg.STAGE1["num_classes"], kernel_size=1)

    def forward(self, x):
        return self.model(x)['out']